<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor de Clientes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 80vh; width: 100%; }
    .filtros { padding: 10px; background: #f0f0f0; display: flex; flex-wrap: wrap; gap: 10px; }
    .filtros select, .filtros input { padding: 5px; font-size: 14px; }
    #mensaje { padding: 5px; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <h2 style="text-align:center">Visor de Clientes en el Mapa</h2>
  <div id="mensaje">Cargando datos...</div>

  <div class="filtros">
    <select id="canal"><option value="">Canal</option></select>
    <select id="ruta"><option value="">Ruta</option></select>
    <select id="supervisor"><option value="">Supervisor</option></select>
    <select id="region"><option value="">Región</option></select>
    <select id="sucursal"><option value="">Sucursal</option></select>
    <select id="departamento"><option value="">Departamento</option></select>
    <select id="municipio"><option value="">Municipio</option></select>
    <select id="dia"><option value="">Día de Visita</option></select>
    <select id="semana"><option value="">Semana</option></select>

    <input type="text" id="busqueda" placeholder="Buscar por nombre o código" />
    <button onclick="buscarCliente()">Buscar</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let clientes = [];
    let marcadores = [];
    let mapa;

    async function cargarDatos() {
      const mensaje = document.getElementById("mensaje");
      try {
        const respuesta = await fetch("https://script.google.com/macros/s/AKfycbwk-Ixt2cYiHtazonaP00FRZQy2_xI1gwtryR7e-d9R4n0ErtbkHz8d3TQMjAlrhYfJ/exec");
        if (!respuesta.ok) throw new Error("No se pudo conectar al servidor");

        const datos = await respuesta.json();

        if (!Array.isArray(datos) || datos.length === 0) {
          mensaje.textContent = "No se encontraron datos en la hoja.";
          mensaje.style.color = "red";
          return;
        }

        const obligatorios = ["Nombre", "Latitud", "Longitud"];
        for (let campo of obligatorios) {
          if (!(campo in datos[0])) {
            mensaje.textContent = "Falta el campo requerido: " + campo;
            mensaje.style.color = "red";
            return;
          }
        }

        clientes = datos;
        mensaje.textContent = "Datos cargados correctamente.";
        mensaje.style.color = "green";

        inicializarMapa();
        inicializarFiltros();
        mostrarMarcadores(clientes);
      } catch (error) {
        mensaje.textContent = "Error al cargar datos: " + error.message;
        mensaje.style.color = "red";
      }
    }

    function inicializarMapa() {
      mapa = L.map("map").setView([14.6349, -90.5069], 7);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(mapa);
    }

    function inicializarFiltros() {
      const filtros = ["region", "sucursal", "supervisor", "ruta", "canal", "departamento", "municipio", "dia", "semana"];

      filtros.forEach(id => {
        const select = document.getElementById(id);
        select.addEventListener("change", () => {
          if (["region", "sucursal", "supervisor"].includes(id)) {
            actualizarOpcionesDependientes();
          }
          aplicarFiltros();
        });
      });

      actualizarOpcionesDependientes();
    }

    function actualizarOpcionesDependientes() {
      const region = document.getElementById("region").value;
      const sucursal = document.getElementById("sucursal").value;
      const supervisor = document.getElementById("supervisor").value;

      const filtrar = cliente => {
        return (!region || cliente["Región"] === region) &&
               (!sucursal || cliente["Sucursal"] === sucursal) &&
               (!supervisor || cliente["Supervisor"] === supervisor);
      };

      const opciones = campo => {
        return [...new Set(clientes.filter(filtrar).map(c => c[campo]).filter(Boolean))].sort();
      };

      const actualizarSelect = (id, valores) => {
        const select = document.getElementById(id);
        const seleccionado = select.value;
        select.innerHTML = `<option value="">${select.options[0].text}</option>`;
        valores.forEach(valor => {
          const option = document.createElement("option");
          option.value = valor;
          option.textContent = valor;
          if (valor === seleccionado) option.selected = true;
          select.appendChild(option);
        });
      };

      actualizarSelect("sucursal", opciones("Sucursal"));
      actualizarSelect("supervisor", opciones("Supervisor"));
      actualizarSelect("ruta", opciones("Ruta"));
      actualizarSelect("canal", opciones("Canal"));
      actualizarSelect("departamento", opciones("Departamento"));
      actualizarSelect("municipio", opciones("Municipio"));
      actualizarSelect("dia", opciones("Día de Visita"));
      actualizarSelect("semana", opciones("Semana"));
    }

    function aplicarFiltros() {
      const filtros = {
        "Canal": document.getElementById("canal").value,
        "Ruta": document.getElementById("ruta").value,
        "Supervisor": document.getElementById("supervisor").value,
        "Región": document.getElementById("region").value,
        "Sucursal": document.getElementById("sucursal").value,
        "Departamento": document.getElementById("departamento").value,
        "Municipio": document.getElementById("municipio").value,
        "Día de Visita": document.getElementById("dia").value,
        "Semana": document.getElementById("semana").value
      };

      const filtrados = clientes.filter(cliente => {
        return Object.entries(filtros).every(([clave, valor]) => {
          return valor === "" || cliente[clave] === valor;
        });
      });

      mostrarMarcadores(filtrados);
    }

    function mostrarMarcadores(lista) {
      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      lista.forEach(cliente => {
        const lat = parseFloat(cliente["Latitud"]);
        const lon = parseFloat(cliente["Longitud"]);
        if (isNaN(lat) || isNaN(lon)) return;

        const marcador = L.marker([lat, lon]).addTo(mapa);
        const info = Object.entries(cliente)
          .map(([k, v]) => `<b>${k}</b>: ${v}`)
          .join("<br>");
        marcador.bindPopup(info);
        marcadores.push(marcador);
      });

      if (marcadores.length > 0) {
        const grupo = L.featureGroup(marcadores);
        mapa.fitBounds(grupo.getBounds());
      }
    }

    function buscarCliente() {
      const texto = document.getElementById("busqueda").value.toLowerCase();
      if (!texto) return;

      const cliente = clientes.find(c =>
        (c["Nombre"] && c["Nombre"].toLowerCase().includes(texto)) ||
        (c["Código"] && c["Código"].toString().toLowerCase().includes(texto))
      );

      if (cliente && cliente["Latitud"] && cliente["Longitud"]) {
        const lat = parseFloat(cliente["Latitud"]);
        const lon = parseFloat(cliente["Longitud"]);
        mapa.setView([lat, lon], 16);

        const info = Object.entries(cliente)
          .map(([k, v]) => `<b>${k}</b>: ${v}`)
          .join("<br>");
        L.popup().setLatLng([lat, lon]).setContent(info).openOn(mapa);
      } else {
        alert("Cliente no encontrado.");
      }
    }

    window.onload = cargarDatos;
  </script>
</body>
</html>


   



