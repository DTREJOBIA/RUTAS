<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Visor de Clientes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Estilos generales y reseteo básico */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6; /* Fondo suave */
            color: #333;
            line-height: 1.6;
        }

        /* Contenedor principal para centrar el contenido */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            box-sizing: border-box;
        }

        /* Encabezado */
        h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em; /* Tamaño de fuente adaptable */
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            display: inline-block; /* Para que el borde se ajuste al texto */
            margin-left: auto;
            margin-right: auto;
            display: block; /* Para centrar el inline-block */
        }

        /* Mensajes de estado */
        #mensaje {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            background-color: #e0f2f7; /* Fondo para mensajes azules */
            color: #007bff; /* Color de texto para mensajes azules */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #mensaje.success { /* Estilo para mensajes de éxito */
            background-color: #e6ffed;
            color: #28a745;
        }
        #mensaje.error { /* Estilo para mensajes de error */
            background-color: #ffe6e6;
            color: #dc3545;
        }
        #mensaje.warning { /* Estilo para mensajes de advertencia */
            background-color: #fff9e6;
            color: #ffc107;
        }


        /* Contenedor de filtros y botones */
        .filtros {
            padding: 15px;
            background: #ffffff; /* Fondo blanco para la barra de filtros */
            display: flex;
            flex-wrap: wrap;
            gap: 12px; /* Espacio entre elementos */
            align-items: center;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Sombra suave */
            margin-bottom: 20px;
        }

        /* Estilos de los selectores e input */
        .filtros select,
        .filtros input[type="text"] {
            flex: 1; /* Permite que los elementos crezcan */
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            min-width: 150px; /* Ancho mínimo para elementos */
            box-sizing: border-box; /* Incluye padding y borde en el ancho */
        }

        /* Estilos de los botones */
        .filtros button {
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap; /* Evita que el texto del botón se rompa */
        }

        /* Estilo para el botón de búsqueda */
        #botonBuscar {
            background-color: #007bff;
            color: white;
            border: none;
        }
        #botonBuscar:hover {
            background-color: #0056b3;
            transform: translateY(-1px); /* Efecto de elevación */
        }

        /* Estilo para el botón de ubicación actual */
        #ubicacionActualBtn {
            background-color: #28a745; /* Verde para ubicación */
            color: white;
            border: none;
        }
        #ubicacionActualBtn:hover {
            background-color: #1e7e34;
            transform: translateY(-1px);
        }

        /* Estilos del mapa */
        #map {
            height: 70vh; /* Ajustado ligeramente para más espacio */
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Media Queries para responsividad */
        @media (max-width: 768px) {
            .filtros {
                flex-direction: column; /* Apila los filtros en columnas */
                align-items: stretch; /* Estira los elementos al 100% */
            }
            .filtros select,
            .filtros input[type="text"],
            .filtros button {
                width: 100%; /* Ocupan todo el ancho disponible */
                min-width: unset; /* Elimina el mínimo ancho */
            }
            h2 {
                font-size: 1.5em;
            }
            #map {
                height: 60vh; /* Mapa un poco más pequeño en móviles */
            }
            .container {
                margin: 10px auto;
                padding: 0 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container"> <h2>Visor de Clientes en el Mapa</h2>
        <div id="mensaje">Cargando datos...</div>

        <div class="filtros">
            <select id="ruta"><option value="">Ruta</option></select>
            <select id="semana"><option value="">Semana</option></select>
            <select id="dia"><option value="">Día de Visita</option></select>
            <input type="text" id="busqueda" placeholder="Buscar por nombre o código" />
            <button id="botonBuscar">Buscar</button>
            <button id="ubicacionActualBtn">Mi Ubicación</button> </div>

        <div id="map"></div>
    </div> <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let clientes = [];
        let marcadores = [];
        let mapa;
        let ubicacionActualMarker; // Para guardar el marcador de la ubicación actual

        // Función auxiliar para manejar mensajes de estado con clases CSS
        function setMensaje(text, type = "info") {
            const mensaje = document.getElementById("mensaje");
            mensaje.textContent = text;
            mensaje.className = ""; // Limpiar clases existentes
            mensaje.classList.add(type); // Añadir la clase de tipo
        }


        async function cargarDatos() {
            setMensaje("Cargando datos...", "info");

            try {
                const respuesta = await fetch("https://script.google.com/macros/s/AKfycbwWOCQz7M7NZ8ST2XDgmBfr3gWRoG8VEr_qU70kPyVkppAUxdMb9todmvhK_rWH2JcH/exec");
                if (!respuesta.ok) throw new Error("No se pudo conectar al servidor.");

                const datos = await respuesta.json();

                if (!Array.isArray(datos) || datos.length === 0) {
                    setMensaje("No se encontraron datos en la hoja.", "warning");
                    return;
                }

                const obligatorios = ["Nombre", "Latitud", "Longitud", "Ruta"];
                for (let campo of obligatorios) {
                    if (!(campo in datos[0])) {
                        setMensaje(`Falta el campo requerido: ${campo}. Asegúrese de que los encabezados coincidan.`, "error");
                        return;
                    }
                }

                clientes = datos;
                setMensaje("Datos cargados correctamente. Seleccione una ruta para ver clientes.", "success");

                inicializarMapa();
                inicializarFiltros();
                // Inicializar el botón de ubicación
                document.getElementById("ubicacionActualBtn").addEventListener("click", mostrarUbicacionActual);

            } catch (error) {
                setMensaje(`Error al cargar datos: ${error.message}`, "error");
            }
        }

        function inicializarMapa() {
            if (mapa) {
                mapa.remove(); // Elimina el mapa existente si ya fue inicializado
            }
            mapa = L.map("map").setView([14.6349, -90.5069], 7); // Coordenadas de ejemplo (Guatemala)
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "© OpenStreetMap contributors"
            }).addTo(mapa);
        }

        function inicializarFiltros() {
            document.getElementById("ruta").addEventListener("change", () => {
                document.getElementById("semana").value = "";
                document.getElementById("dia").value = "";
                actualizarFiltroSemana();
                aplicarFiltros();
            });

            document.getElementById("semana").addEventListener("change", () => {
                actualizarFiltroDia();
                aplicarFiltros();
            });
            document.getElementById("dia").addEventListener("change", aplicarFiltros);

            document.getElementById("busqueda").addEventListener("input", function() {
                if (this.value === "") {
                    buscarCliente();
                }
            });
            document.getElementById("botonBuscar").addEventListener("click", buscarCliente);

            cargarFiltroRutaInicial();
        }

        function cargarFiltroRutaInicial() {
            const todasRutas = [...new Set(clientes.map(c => c["Ruta"]).filter(Boolean))].sort();
            actualizarSelect("ruta", todasRutas, "Ruta");

            setMensaje("Seleccione una ruta para ver clientes en el mapa.", "info");
            mostrarMarcadores([]);
            actualizarFiltroSemana();
        }

        function actualizarFiltroSemana() {
            const rutaSeleccionada = document.getElementById("ruta").value;
            let semanas = [];

            if (rutaSeleccionada) {
                const clientesEnRuta = clientes.filter(c => c["Ruta"] === rutaSeleccionada);
                semanas = [...new Set(clientesEnRuta.map(c => c["Semana"]).filter(Boolean))].sort();
            }
            actualizarSelect("semana", semanas, "Semana");
            actualizarFiltroDia();
        }

        function actualizarFiltroDia() {
            const rutaSeleccionada = document.getElementById("ruta").value;
            const semanaSeleccionada = document.getElementById("semana").value;
            let dias = [];

            if (rutaSeleccionada) {
                let clientesParaDias = clientes.filter(c => c["Ruta"] === rutaSeleccionada);
                if (semanaSeleccionada) {
                    clientesParaDias = clientesParaDias.filter(c => c["Semana"] === semanaSeleccionada);
                }
                dias = [...new Set(clientesParaDias.map(c => c["Día de Visita"]).filter(Boolean))].sort();
            }
            actualizarSelect("dia", dias, "Día de Visita");
        }

        function actualizarSelect(id, valores, placeholderText) {
            const select = document.getElementById(id);
            const seleccionado = select.value;
            select.innerHTML = `<option value="">${placeholderText}</option>`;

            valores.forEach(valor => {
                const option = document.createElement("option");
                option.value = valor;
                option.textContent = valor;
                if (valor === seleccionado) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function aplicarFiltros() {
            const ruta = document.getElementById("ruta").value;
            const semana = document.getElementById("semana").value;
            const dia = document.getElementById("dia").value;

            if (!ruta) {
                setMensaje("Seleccione una ruta para ver clientes en el mapa.", "info");
                mostrarMarcadores([]);
                return;
            }

            const filtrados = clientes.filter(c =>
                (c["Ruta"] === ruta) &&
                (!semana || c["Semana"] === semana) &&
                (!dia || c["Día de Visita"] === dia)
            );

            if (filtrados.length === 0) {
                setMensaje("No se encontraron clientes para los filtros seleccionados en esta ruta.", "warning");
            } else {
                setMensaje(`Mostrando ${filtrados.length} cliente(s) en la ruta seleccionada.`, "success");
            }
            mostrarMarcadores(filtrados);
        }

        function mostrarMarcadores(lista) {
            marcadores.forEach(m => mapa.removeLayer(m));
            marcadores = [];

            if (ubicacionActualMarker) { // Asegura que el marcador de ubicación actual se mantenga
                ubicacionActualMarker.addTo(mapa);
                marcadores.push(ubicacionActualMarker); // Añadirlo para que `fitBounds` lo considere
            }

            if (lista.length === 0) {
                if (marcadores.length === 0) { // Si no hay clientes ni marcador de ubicación
                    if (mapa && mapa.getBounds().isValid()) {
                        mapa.setView([14.6349, -90.5069], 7);
                    }
                } else { // Si solo hay marcador de ubicación
                    mapa.setView(ubicacionActualMarker.getLatLng(), 13); // Centrar en la ubicación actual con zoom
                }
                return;
            }

            lista.forEach(cliente => {
                const lat = parseFloat(cliente["Latitud"]);
                const lon = parseFloat(cliente["Longitud"]);

                if (isNaN(lat) || isNaN(lon)) {
                    console.warn(`Cliente "${cliente["Nombre"] || cliente["Código"]}" tiene coordenadas inválidas: Lat ${cliente["Latitud"]}, Lon ${cliente["Longitud"]}. Ignorando.`);
                    return;
                }

                const marcador = L.marker([lat, lon]).addTo(mapa);
                const info = `
                    <b>Código:</b> ${cliente["Código"] || "N/A"}<br>
                    <b>Nombre:</b> ${cliente["Nombre"] || "N/A"}<br>
                    <b>Ruta:</b> ${cliente["Ruta"] || "N/A"}<br>
                    <b>Semana:</b> ${cliente["Semana"] || "N/A"}<br>
                    <b>Día:</b> ${cliente["Día de Visita"] || "N/A"}<br>
                    <b>Dirección:</b> ${cliente["Dirección"] || "N/A"}<br>
                    <b>Teléfono:</b> ${cliente["Teléfono"] || "N/A"}<br>
                    <b>ID:</b> ${cliente["ID"] || "N/A"}<br>
                    <b>RTN:</b> ${cliente["RTN"] || "N/A"}<br>
                    <b>Canal:</b> ${cliente["Canal"] || "N/A"}<br>
                    <b>Supervisor:</b> ${cliente["Supervisor"] || "N/A"}<br>
                    <b>Región:</b> ${cliente["Región"] || "N/A"}<br>
                    <b>Sucursal:</b> ${cliente["Sucursal"] || "N/A"}<br>
                    <b>Departamento:</b> ${cliente["Departamento"] || "N/A"}<br>
                    <b>Municipio:</b> ${cliente["Municipio"] || "N/A"}`;
                marcador.bindPopup(info);
                marcadores.push(marcador);
            });

            if (marcadores.length > 0) {
                const grupo = L.featureGroup(marcadores);
                mapa.fitBounds(grupo.getBounds(), { padding: [20, 20] }); // Añadir un pequeño padding
            }
        }

        function buscarCliente() {
            const texto = document.getElementById("busqueda").value.toLowerCase().trim();

            document.getElementById("ruta").value = "";
            document.getElementById("semana").value = "";
            document.getElementById("dia").value = "";
            actualizarFiltroSemana();

            if (!texto) {
                cargarFiltroRutaInicial();
                return;
            }

            const coincidencias = clientes.filter(c =>
                (c["Nombre"] && c["Nombre"].toLowerCase().includes(texto)) ||
                (c["Código"] && c["Código"].toString().toLowerCase().includes(texto))
            );

            if (coincidencias.length === 0) {
                setMensaje("No se encontraron clientes con ese nombre o código.", "warning");
            } else {
                setMensaje(`Mostrando ${coincidencias.length} cliente(s) por búsqueda.`, "success");
            }
            mostrarMarcadores(coincidencias);
        }

        // --- Nuevas funciones para la ubicación actual ---
        function mostrarUbicacionActual() {
            if ("geolocation" in navigator) {
                setMensaje("Obteniendo tu ubicación actual...", "info");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        // Eliminar marcador anterior si existe
                        if (ubicacionActualMarker) {
                            mapa.removeLayer(ubicacionActualMarker);
                        }

                        // Crear un marcador para la ubicación actual (puede ser un icono personalizado)
                        ubicacionActualMarker = L.marker([lat, lon], {
                            icon: L.divIcon({ // Usar un icono personalizado para diferenciar
                                className: 'ubicacion-actual-icon',
                                html: '<div style="background-color: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
                                iconSize: [26, 26], // Tamaño total del icono
                                iconAnchor: [13, 13] // Punto de anclaje central
                            })
                        }).addTo(mapa)
                          .bindPopup("¡Estás aquí!").openPopup();

                        mapa.setView([lat, lon], 15); // Centra y hace zoom en la ubicación actual

                        // Resetear filtros y mostrar solo la ubicación actual, o agregar a clientes si hay filtros
                        document.getElementById("ruta").value = "";
                        document.getElementById("semana").value = "";
                        document.getElementById("dia").value = "";
                        actualizarFiltroSemana(); // Repuebla los selects
                        mostrarMarcadores([]); // Limpia los marcadores de clientes (si los había), pero mantiene el de ubicación
                        setMensaje("Tu ubicación actual ha sido marcada en el mapa.", "success");
                    },
                    (error) => {
                        let errorMessage = "No se pudo obtener tu ubicación.";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Permiso denegado para acceder a la ubicación. Asegúrate de permitirlo en la configuración de tu navegador.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Información de ubicación no disponible.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Tiempo de espera agotado para obtener la ubicación.";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage = "Error desconocido al obtener la ubicación.";
                                break;
                        }
                        setMensaje(errorMessage, "error");
                        console.error("Error al obtener ubicación:", error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                setMensaje("La geolocalización no está soportada por tu navegador.", "error");
            }
        }
        // --- Fin nuevas funciones ---

        window.onload = cargarDatos;
    </script>
</body>
</html>
