<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor de Clientes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 80vh; width: 100%; }
    .filtros { padding: 10px; background: #f0f0f0; display: flex; flex-wrap: wrap; gap: 10px; }
    .filtros select, .filtros input { padding: 5px; font-size: 14px; }
    #mensaje { padding: 5px; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <h2 style="text-align:center">Visor de Clientes en el Mapa</h2>
  <div id="mensaje">Cargando datos...</div>

  <div class="filtros">
    <select id="ruta"><option value="">Ruta</option></select>
    <select id="semana"><option value="">Semana</option></select>
    <select id="dia"><option value="">Día de Visita</option></select>

    <input type="text" id="busqueda" placeholder="Buscar por nombre o código" oninput="buscarCliente()" />
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let clientes = [];
    let marcadores = [];
    let mapa;

    async function cargarDatos() {
      const mensaje = document.getElementById("mensaje");
      try {
        const respuesta = await fetch("https://script.google.com/macros/s/AKfycbwk-Ixt2cYiHtazonaP00FRZQy2_xI1gwtryR7e-d9R4n0ErtbkHz8d3TQMjAlrhYfJ/exec");
        if (!respuesta.ok) throw new Error("No se pudo conectar al servidor");

        const datos = await respuesta.json();

        if (!Array.isArray(datos) || datos.length === 0) {
          mensaje.textContent = "No se encontraron datos en la hoja.";
          mensaje.style.color = "red";
          return;
        }

        const obligatorios = ["Nombre", "Latitud", "Longitud"];
        for (let campo of obligatorios) {
          if (!(campo in datos[0])) {
            mensaje.textContent = "Falta el campo requerido: " + campo;
            mensaje.style.color = "red";
            return;
          }
        }

        clientes = datos;
        mensaje.textContent = "Datos cargados. Usa los filtros o el buscador para ver los clientes.";
        mensaje.style.color = "green";

        inicializarMapa();
        inicializarFiltros();
      } catch (error) {
        mensaje.textContent = "Error al cargar datos: " + error.message;
        mensaje.style.color = "red";
      }
    }

    function inicializarMapa() {
      mapa = L.map("map").setView([14.6349, -90.5069], 7);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(mapa);
    }

    function inicializarFiltros() {
      document.getElementById("ruta").addEventListener("change", actualizarSemanaYDia);
      document.getElementById("semana").addEventListener("change", aplicarFiltros);
      document.getElementById("dia").addEventListener("change", aplicarFiltros);
      actualizarRuta();
    }

    function actualizarRuta() {
      const rutas = [...new Set(clientes.map(c => c["Ruta"]).filter(Boolean))].sort();
      actualizarSelect("ruta", rutas);
    }

    function actualizarSemanaYDia() {
      const rutaSeleccionada = document.getElementById("ruta").value;
      const filtrados = clientes.filter(c => !rutaSeleccionada || c["Ruta"] === rutaSeleccionada);

      const semanas = [...new Set(filtrados.map(c => c["Semana"]).filter(Boolean))].sort();
      const dias = [...new Set(filtrados.map(c => c["Día de Visita"]).filter(Boolean))].sort();

      actualizarSelect("semana", semanas);
      actualizarSelect("dia", dias);

      aplicarFiltros();
    }

    function actualizarSelect(id, valores) {
      const select = document.getElementById(id);
      const seleccionado = select.value;
      select.innerHTML = `<option value="">${select.options[0].text}</option>`;
      valores.forEach(valor => {
        const option = document.createElement("option");
        option.value = valor;
        option.textContent = valor;
        if (valor === seleccionado) option.selected = true;
        select.appendChild(option);
      });
    }

    function aplicarFiltros() {
      const ruta = document.getElementById("ruta").value;
      const semana = document.getElementById("semana").value;
      const dia = document.getElementById("dia").value;

      const filtrados = clientes.filter(c => {
        return (!ruta || c["Ruta"] === ruta) &&
               (!semana || c["Semana"] === semana) &&
               (!dia || c["Día de Visita"] === dia);
      });

      mostrarMarcadores(filtrados);
    }

    function mostrarMarcadores(lista) {
      marcadores.forEach(m => mapa.removeLayer(m));
      marcadores = [];

      lista.forEach(cliente => {
        const lat = parseFloat(cliente["Latitud"]);
        const lon = parseFloat(cliente["Longitud"]);
        if (isNaN(lat) || isNaN(lon)) return;

        const marcador = L.marker([lat, lon]).addTo(mapa);
        const info = Object.entries(cliente)
          .map(([k, v]) => `<b>${k}</b>: ${v}`)
          .join("<br>");
        marcador.bindPopup(info);
        marcadores.push(marcador);
      });

      if (marcadores.length > 0) {
        const grupo = L.featureGroup(marcadores);
        mapa.fitBounds(grupo.getBounds());
      }
    }

    function buscarCliente() {
      const texto = document.getElementById("busqueda").value.toLowerCase();
      if (!texto) return;

      const coincidencias = clientes.filter(c =>
        (c["Nombre"] && c["Nombre"].toLowerCase().includes(texto)) ||
        (c["Código"] && c["Código"].toString().toLowerCase().includes(texto))
      );

      mostrarMarcadores(coincidencias);
    }

    window.onload = cargarDatos;
  </script>
</body>
</html>

